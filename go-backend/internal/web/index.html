<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<title>Pi Face Monitor</title>
<style>
body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans SC", Arial, sans-serif; margin: 20px; }
h1 { margin-bottom: 8px; }
.panel { display:flex; gap:24px; align-items:flex-start; flex-wrap: wrap; }
img { border:1px solid #ddd; border-radius:12px; max-width: 640px; }
.badge { padding:6px 10px; background:#f2f4f7; border-radius:8px; display:inline-block; margin-top:8px; }
table { border-collapse: collapse; margin-top: 16px; width: 640px; }
th, td { border-bottom: 1px solid #eee; padding: 8px 6px; text-align: left; font-size: 14px; }
</style>
</head>
<body>
  <h1>实时监控 & 识别</h1>
  <div class="panel">
    <div>
      <img id="stream" src="/video_feed" />
      <div class="badge" id="status">加载中…</div>

      <h3>最近访客记录</h3>
      <table id="tbl">
        <thead><tr><th>ID</th><th>姓名</th><th>置信度</th><th>时间</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
async function tick(){
  try{
    const r = await fetch('/api/py/last');
    const j = await r.json();
    const text = (j.recognized ? '✅ ' : '❌ ') + (j.name || '-') + ' / ' + (j.confidence||0).toFixed(2);
    document.getElementById('status').innerText = text;
  }catch(e){
    document.getElementById('status').innerText = '状态获取失败';
  }finally{
    setTimeout(tick, 800);
  }
}

async function loadRecords(){
  try{
    const r = await fetch('/api/records?limit=50');
    const data = await r.json();
    const tb = document.querySelector('#tbl tbody');
    tb.innerHTML = '';
    data.forEach(row=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${row.id}</td><td>${row.name}</td><td>${row.confidence.toFixed(3)}</td><td>${row.timestamp}</td>`;
      tb.appendChild(tr);
    });
  }catch(e){
    console.error(e);
  }
}

tick();
setInterval(loadRecords, 3000);
loadRecords();
</script>
</body>
</html>
