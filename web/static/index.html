<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>äººè„¸è¯†åˆ«è®°å½•çœ‹æ¿</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CDNï¼Œç”¨äºå¿«é€Ÿç¾åŒ–ç•Œé¢ -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <div class="max-w-6xl mx-auto px-4 py-6">
    <!-- é¡¶éƒ¨æ ‡é¢˜ -->
    <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-6">
      <div>
        <h1 class="text-3xl font-semibold tracking-tight">
          äººè„¸è¯†åˆ«è®°å½•çœ‹æ¿
        </h1>
        <p class="text-sm text-slate-400 mt-1">
          å®æ—¶æŸ¥çœ‹è¯†åˆ«æ—¥å¿—ã€é”™è¯¯å‘Šè­¦ä¸é˜ˆå€¼å‘½ä¸­æƒ…å†µ
        </p>
      </div>
      <div class="flex gap-3">
        <button
          id="refreshBtn"
          class="inline-flex items-center justify-center px-4 py-2 rounded-xl text-sm font-medium bg-sky-500 hover:bg-sky-400 text-slate-950 shadow-lg shadow-sky-900/40 transition">
          æ‰‹åŠ¨åˆ·æ–°
        </button>
      </div>
    </header>

    <!-- ç­›é€‰ + è¡¨æ ¼ -->
    <section
      class="bg-slate-900/70 border border-slate-700/60 rounded-2xl p-4 md:p-5 shadow-xl shadow-slate-950/60">
      <!-- ç­›é€‰åŒº -->
      <div class="flex flex-col md:flex-row md:items-center gap-3 mb-4">
        <!-- æœç´¢ -->
        <div class="flex-1">
          <label class="block text-xs font-medium text-slate-400 mb-1">
            æœç´¢ï¼ˆå§“å / å›¾ç‰‡è·¯å¾„ / æ¶ˆæ¯ï¼‰
          </label>
          <div
            class="flex items-center gap-2 rounded-xl border border-slate-700 bg-slate-900/60 px-3 py-2 focus-within:border-sky-500/70">
            <span class="text-slate-500 text-sm">ğŸ”</span>
            <input
              id="searchInput"
              type="text"
              placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰ / ERROR / unknow/x1.jpg"
              class="w-full bg-transparent outline-none text-sm placeholder:text-slate-500" />
          </div>
        </div>

        <!-- çŠ¶æ€ç­›é€‰ -->
        <div class="w-full md:w-48">
          <label class="block text-xs font-medium text-slate-400 mb-1">
            çŠ¶æ€ç­›é€‰
          </label>
          <select
            id="statusFilter"
            class="w-full text-sm rounded-xl border border-slate-700 bg-slate-900/80 px-3 py-2 focus:border-sky-500/70 outline-none">
            <option value="">å…¨éƒ¨çŠ¶æ€</option>
            <option value="OK">æ­£å¸¸ï¼ˆOKï¼‰</option>
            <option value="ERROR">é”™è¯¯ï¼ˆERRORï¼‰</option>
            <option value="NO_FACE">æœªæ£€æµ‹äººè„¸ï¼ˆNO_FACEï¼‰</option>
          </select>
        </div>
      </div>

      <!-- è¡¨æ ¼ -->
      <div class="overflow-x-auto border border-slate-800/80 rounded-2xl">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-900/80 border-b border-slate-800 text-slate-300">
            <tr>
              <th class="px-3 py-2 text-left font-medium text-xs uppercase tracking-wide">
                æ—¶é—´
              </th>
              <th class="px-3 py-2 text-left font-medium text-xs uppercase tracking-wide">
                å›¾ç‰‡
              </th>
              <th class="px-3 py-2 text-left font-medium text-xs uppercase tracking-wide">
                åŒ¹é…å§“å
              </th>
              <th class="px-3 py-2 text-left font-medium text-xs uppercase tracking-wide">
                ç›¸ä¼¼åº¦
              </th>
              <th class="px-3 py-2 text-left font-medium text-xs uppercase tracking-wide">
                é˜ˆå€¼
              </th>
              <th class="px-3 py-2 text-left font-medium text-xs uppercase tracking-wide">
                çŠ¶æ€
              </th>
              <th class="px-3 py-2 text-left font-medium text-xs uppercase tracking-wide">
                æ¶ˆæ¯
              </th>
            </tr>
          </thead>
          <tbody id="tableBody" class="divide-y divide-slate-800"></tbody>
        </table>
      </div>

      <!-- åˆ†é¡µ + ç»Ÿè®¡ -->
      <div
        class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mt-4 text-xs text-slate-400">
        <div id="summary">æ­£åœ¨åŠ è½½...</div>
        <div class="flex items-center gap-2">
          <button
            id="prevPage"
            class="px-3 py-1.5 rounded-lg border border-slate-700 bg-slate-900/70 disabled:opacity-40 text-xs">
            ä¸Šä¸€é¡µ
          </button>
          <button
            id="nextPage"
            class="px-3 py-1.5 rounded-lg border border-slate-700 bg-slate-900/70 disabled:opacity-40 text-xs">
            ä¸‹ä¸€é¡µ
          </button>
        </div>
      </div>
    </section>
  </div>

  <!-- å›¾ç‰‡é¢„è§ˆå¼¹çª— -->
  <div
    id="imageModal"
    class="hidden fixed inset-0 z-50 bg-black/70 backdrop-blur-sm items-center justify-center">
    <div class="bg-slate-900/95 border border-slate-700 rounded-2xl max-w-2xl w-[90%] p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-medium text-slate-100">
          æŠ“æ‹å›¾ç‰‡é¢„è§ˆ
        </h2>
        <button
          id="closeModal"
          class="w-8 h-8 inline-flex items-center justify-center rounded-full bg-slate-800 hover:bg-slate-700 text-slate-300 text-sm">
          âœ•
        </button>
      </div>
      <div class="max-h-[70vh] overflow-auto flex justify-center">
        <img
          id="modalImage"
          src=""
          alt="snapshot"
          class="max-h-[70vh] rounded-xl border border-slate-700" />
      </div>
      <p id="modalPath" class="text-[11px] text-slate-500 mt-2 break-all">
      </p>
    </div>
  </div>

  <script>
    let currentPage = 1
    const pageSize = 20
    let totalPages = 1

    // é˜²æŠ–å‡½æ•°ï¼šå‡å°‘é¢‘ç¹è¯·æ±‚
    function debounce(fn, delay) {
      let timer = null
      return function (...args) {
        clearTimeout(timer)
        timer = setTimeout(() => fn.apply(this, args), delay)
      }
    }

    // æ¸²æŸ“çŠ¶æ€å¾½ç« 
    function renderStatusBadge(status) {
      const base =
        'inline-flex items-center px-2 py-[2px] rounded-full text-[11px] font-medium border'
      switch (status) {
        case 'OK':
          return `<span class="${base} bg-emerald-500/10 text-emerald-300 border-emerald-500/40">æ­£å¸¸</span>`
        case 'ERROR':
          return `<span class="${base} bg-rose-500/10 text-rose-300 border-rose-500/40">é”™è¯¯</span>`
        case 'NO_FACE':
          return `<span class="${base} bg-amber-500/10 text-amber-300 border-amber-500/40">æœªæ£€æµ‹äººè„¸</span>`
        default:
          return `<span class="${base} bg-slate-500/10 text-slate-300 border-slate-500/40">${status ||
            'æœªçŸ¥'}</span>`
      }
    }

    // è¯·æ±‚æ•°æ®
    async function fetchData() {
      const status = document.getElementById('statusFilter').value
      const q = document.getElementById('searchInput').value.trim()

      const params = new URLSearchParams()
      params.set('page', String(currentPage))
      params.set('pageSize', String(pageSize))
      if (status) params.set('status', status)
      if (q) params.set('q', q)

      const res = await fetch('/api/records?' + params.toString())
      const json = await res.json()

      renderTable(json.data)
      updateSummary(json)
    }

    // æ¸²æŸ“è¡¨æ ¼
    function renderTable(rows) {
      const tbody = document.getElementById('tableBody')
      tbody.innerHTML = ''

      if (!rows || rows.length === 0) {
        const tr = document.createElement('tr')
        tr.innerHTML =
          '<td colspan="7" class="px-3 py-4 text-center text-sm text-slate-500">æš‚æ— æ•°æ®</td>'
        tbody.appendChild(tr)
        return
      }

      rows.forEach((rec) => {
        const tr = document.createElement('tr')
        tr.className =
          'hover:bg-slate-800/60 transition-colors'

        const similarityText = rec.similarity || '-'
        const thresholdText = rec.threshold || '-'
        const matchNameText = rec.match_name || '-'

        tr.innerHTML = `
          <td class="px-3 py-2 whitespace-nowrap text-xs text-slate-400">
            ${rec.timestamp || ''}
          </td>
          <td class="px-3 py-2 whitespace-nowrap">
            <button
              type="button"
              class="text-[11px] text-sky-300 hover:text-sky-200 underline decoration-dotted"
              data-image-path="${rec.image_path || ''}">
              é¢„è§ˆ
            </button>
            <div class="text-[11px] text-slate-500 truncate max-w-xs">
              ${rec.image_path || ''}
            </div>
          </td>
          <td class="px-3 py-2 whitespace-nowrap text-sm">
            ${matchNameText}
          </td>
          <td class="px-3 py-2 whitespace-nowrap text-xs">
            ${similarityText}
          </td>
          <td class="px-3 py-2 whitespace-nowrap text-xs text-slate-300">
            ${thresholdText}
          </td>
          <td class="px-3 py-2 whitespace-nowrap">
            ${renderStatusBadge(rec.status)}
          </td>
          <td class="px-3 py-2 text-xs text-slate-300 max-w-sm">
            <div class="line-clamp-2">
              ${rec.message || ''}
            </div>
          </td>
        `
        tbody.appendChild(tr)
      })
    }

    // æ›´æ–°åˆ†é¡µä¿¡æ¯
    function updateSummary(meta) {
      const summary = document.getElementById('summary')
      const prevBtn = document.getElementById('prevPage')
      const nextBtn = document.getElementById('nextPage')

      const total = meta.total || 0
      const page = meta.page || 1
      const size = meta.pageSize || pageSize

      totalPages = Math.max(1, Math.ceil(total / size))

      summary.textContent = `å…± ${total} æ¡è®°å½• Â· ç¬¬ ${page} / ${totalPages} é¡µ`

      prevBtn.disabled = page <= 1
      nextBtn.disabled = page >= totalPages
    }

    // æ‰“å¼€/å…³é—­å›¾ç‰‡å¼¹çª—
    function openImageModal(path) {
      const modal = document.getElementById('imageModal')
      const img = document.getElementById('modalImage')
      const text = document.getElementById('modalPath')

      img.src = path || ''
      text.textContent = path || 'æ— å›¾ç‰‡è·¯å¾„'
      modal.classList.remove('hidden')
      modal.classList.add('flex')
    }

    function closeImageModal() {
      const modal = document.getElementById('imageModal')
      const img = document.getElementById('modalImage')

      img.src = ''
      modal.classList.add('hidden')
      modal.classList.remove('flex')
    }

    // åˆå§‹åŒ–äº‹ä»¶
    document.addEventListener('DOMContentLoaded', () => {
      const searchInput = document.getElementById('searchInput')
      const statusFilter = document.getElementById('statusFilter')
      const prevPage = document.getElementById('prevPage')
      const nextPage = document.getElementById('nextPage')
      const refreshBtn = document.getElementById('refreshBtn')
      const tableBody = document.getElementById('tableBody')
      const closeModalBtn = document.getElementById('closeModal')
      const imageModal = document.getElementById('imageModal')

      // æœç´¢é˜²æŠ–
      searchInput.addEventListener(
        'input',
        debounce(() => {
          currentPage = 1
          fetchData()
        }, 300),
      )

      // çŠ¶æ€ç­›é€‰
      statusFilter.addEventListener('change', () => {
        currentPage = 1
        fetchData()
      })

      // åˆ†é¡µ
      prevPage.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--
          fetchData()
        }
      })
      nextPage.addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++
          fetchData()
        }
      })

      // æ‰‹åŠ¨åˆ·æ–°
      refreshBtn.addEventListener('click', () => {
        currentPage = 1
        fetchData()
      })

      // å›¾ç‰‡é¢„è§ˆï¼ˆäº‹ä»¶ä»£ç†ï¼‰
      tableBody.addEventListener('click', (e) => {
        const btn = e.target.closest('[data-image-path]')
        if (!btn) return
        const path = btn.getAttribute('data-image-path') || ''
        if (!path) return
        openImageModal(path)
      })

      // å¼¹çª—å…³é—­
      closeModalBtn.addEventListener('click', closeImageModal)
      imageModal.addEventListener('click', (e) => {
        if (e.target === imageModal) {
          closeImageModal()
        }
      })

      // åˆæ¬¡åŠ è½½
      fetchData()
    })
  </script>
</body>
</html>
