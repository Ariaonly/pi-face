<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>äººè„¸è¯†åˆ«æ—¥å¿—çœ‹æ¿</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <div class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <!-- é¡¶éƒ¨æ ‡é¢˜ -->
    <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
      <div>
        <h1 class="text-3xl font-semibold tracking-tight">
          äººè„¸è¯†åˆ«æ—¥å¿—çœ‹æ¿
        </h1>
        <p class="text-sm text-slate-400 mt-1">
          å›¾è¡¨åªç»Ÿè®¡ <code>status=MATCH</code> çš„è®°å½•ï¼Œå¹¶æŒ‰â€œåŒä¸€äººä¸€å°æ—¶å†…â€åˆå¹¶ä¸ºä¸€æ¬¡æœ‰æ•ˆç­¾åˆ°
        </p>
      </div>
      <div class="flex items-center gap-3">
        <button
          id="refreshBtn"
          class="inline-flex items-center justify-center px-4 py-2 rounded-xl text-sm font-medium bg-sky-500 hover:bg-sky-400 text-slate-950 shadow-lg shadow-sky-900/40 transition">
          åˆ·æ–°æ•°æ®
        </button>
      </div>
    </header>

    <!-- æ¦‚è§ˆå¡ç‰‡ -->
    <section class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
      <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4">
        <div class="text-xs font-medium text-slate-400">åŸå§‹æ€»è®°å½•æ•°ï¼ˆå«å¼‚å¸¸ï¼‰</div>
        <div id="totalCount" class="mt-2 text-2xl font-semibold">-</div>
      </div>
      <div class="rounded-2xl border border-emerald-500/40 bg-slate-900/70 p-4">
        <div class="text-xs font-medium text-emerald-300">æœ‰æ•ˆç­¾åˆ°ï¼ˆstatus=MATCHï¼Œ1 å°æ—¶å»é‡åï¼‰</div>
        <div id="validCount" class="mt-2 text-2xl font-semibold text-emerald-300">-</div>
      </div>
      <div class="rounded-2xl border border-rose-500/40 bg-slate-900/70 p-4">
        <div class="text-xs font-medium text-rose-300">ERROR è®°å½•æ•°</div>
        <div id="errorCount" class="mt-2 text-2xl font-semibold text-rose-300">-</div>
      </div>
      <div class="rounded-2xl border border-amber-500/40 bg-slate-900/70 p-4">
        <div class="text-xs font-medium text-amber-300">NO_FACE è®°å½•æ•°</div>
        <div id="noFaceCount" class="mt-2 text-2xl font-semibold text-amber-300">-</div>
      </div>
    </section>

    <!-- å›¾è¡¨ï¼šæŸäººæŸæ—¥æ¥äº†å‡ æ¬¡ -->
    <section class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 md:p-5">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
        <h2 class="text-sm font-medium text-slate-100">
          æŸäººæŸæ—¥æ¥äº†å‡ æ¬¡ï¼ˆä»…ç»Ÿè®¡ MATCH + ä¸€å°æ—¶å»é‡åçš„æœ‰æ•ˆç­¾åˆ°ï¼‰
        </h2>
        <div class="flex items-center gap-2">
          <label for="personSelect" class="text-xs text-slate-400">é€‰æ‹©äººå‘˜ï¼š</label>
          <select
            id="personSelect"
            class="text-xs md:text-sm rounded-xl border border-slate-700 bg-slate-900/80 px-3 py-1.5 focus:border-sky-500/70 outline-none">
            <option value="">å…¨éƒ¨äººå‘˜ï¼ˆæ€»æ¬¡æ•°ï¼‰</option>
          </select>
        </div>
      </div>
      <div class="relative h-64 md:h-72">
        <canvas id="personDailyChart"></canvas>
      </div>
      <p class="mt-2 text-[11px] text-slate-500">
        ä¸é€‰äººå‘˜æ—¶ï¼Œè¡¨ç¤ºç»Ÿè®¡æ¯å¤©æ€»çš„æœ‰æ•ˆç­¾åˆ°æ¬¡æ•°ï¼›é€‰ä¸­æŸä¸ªäººä¹‹åï¼Œå°±åªçœ‹è¯¥äººæ¯å¤©æ¥äº†å‡ æ¬¡ã€‚
      </p>
    </section>
    <!-- å›¾è¡¨ï¼šæŸæ—¥æœ‰å‡ ä¸ªäººæ¥ -->
    <section class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 md:p-5">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-medium text-slate-100">
          æŸæ—¥æœ‰å‡ ä¸ªäººæ¥ï¼ˆæ¯å¤©æœ‰æ•ˆè®¿å®¢äººæ•°ï¼Œå»é‡ï¼Œä»…ç»Ÿè®¡ MATCHï¼‰
        </h2>
      </div>
      <div class="relative h-64 md:h-72">
        <canvas id="dayPeopleChart"></canvas>
      </div>
    </section>

    <!-- å›¾è¡¨ï¼šæŸæœˆæŸäººæ¥çš„å¤©æ•° -->
    <section class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 md:p-5">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
        <h2 class="text-sm font-medium text-slate-100">
          æŸæœˆæŸäººæ¥çš„å¤©æ•°ï¼ˆå»é‡å¤©æ•°ï¼Œä»…ç»Ÿè®¡ MATCHï¼‰
        </h2>
        <div class="flex items-center gap-2">
          <label for="monthSelect" class="text-xs text-slate-400">é€‰æ‹©æœˆä»½ï¼š</label>
          <select
            id="monthSelect"
            class="text-xs md:text-sm rounded-xl border border-slate-700 bg-slate-900/80 px-3 py-1.5 focus:border-sky-500/70 outline-none">
            <option value="">å…¨éƒ¨æœˆä»½</option>
          </select>
        </div>
      </div>
      <div class="relative h-64 md:h-72">
        <canvas id="monthPersonChart"></canvas>
      </div>
      <p class="mt-2 text-[11px] text-slate-500">
        é€‰æ‹©æŸä¸ªæœˆåï¼Œæ¨ªè½´æ˜¯äººå‘˜ï¼Œçºµè½´æ˜¯è¿™ä¸ªæœˆå†…æ¥è¿‡çš„å¤©æ•°ï¼ˆåŒä¸€å¤©å†…å¤šæ¬¡æœ‰æ•ˆç­¾åˆ°åªç®— 1 å¤©ï¼‰ã€‚
      </p>
    </section>

    <!-- åˆ—è¡¨ + ç­›é€‰ï¼ˆåŸå§‹è®°å½•ï¼‰ -->
    <section class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 md:p-5">
      <!-- ç­›é€‰åŒº -->
      <div class="flex flex-col md:flex-row md:items-center gap-3 mb-4">
        <div class="flex-1">
          <label class="block text-xs font-medium text-slate-400 mb-1">
            æœç´¢ï¼ˆå§“å / çŠ¶æ€ / æ¶ˆæ¯ / å›¾ç‰‡è·¯å¾„ï¼‰
          </label>
          <div
            class="flex items-center gap-2 rounded-xl border border-slate-700 bg-slate-900/60 px-3 py-2 focus-within:border-sky-500/70">
            <span class="text-slate-500 text-sm">ğŸ”</span>
            <input
              id="searchInput"
              type="text"
              placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰ / MATCH / ERROR / NO_FACE"
              class="w-full bg-transparent outline-none text-sm placeholder:text-slate-500" />
          </div>
        </div>
        <div class="w-full md:w-56">
          <label class="block text-xs font-medium text-slate-400 mb-1">
            çŠ¶æ€ç­›é€‰
          </label>
          <select
            id="statusFilter"
            class="w-full text-sm rounded-xl border border-slate-700 bg-slate-900/80 px-3 py-2 focus:border-sky-500/70 outline-none">
            <option value="">å…¨éƒ¨çŠ¶æ€</option>
            <option value="MATCH">MATCHï¼ˆæœ‰æ•ˆè®°å½•ï¼‰</option>
            <option value="ERROR">ERROR</option>
            <option value="NO_FACE">NO_FACE</option>
          </select>
        </div>
      </div>

      <!-- è¡¨æ ¼ -->
      <div class="overflow-x-auto border border-slate-800 rounded-2xl">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-900/80 border-b border-slate-800 text-slate-300">
            <tr>
              <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wide">æ—¶é—´</th>
              <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wide">å§“å</th>
              <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wide">ç›¸ä¼¼åº¦</th>
              <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wide">é˜ˆå€¼</th>
              <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wide">çŠ¶æ€</th>
              <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wide">å›¾ç‰‡è·¯å¾„</th>
              <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wide">æ¶ˆæ¯</th>
              <th class="px-3 py-2 text-right text-xs font-medium uppercase tracking-wide">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="tableBody" class="divide-y divide-slate-800"></tbody>
        </table>
      </div>
      <!-- åˆ†é¡µ -->
      <div
        class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mt-4 text-xs text-slate-400">
        <div id="summary">æ­£åœ¨åŠ è½½...</div>
        <div class="flex items-center gap-2">
          <button
            id="prevPage"
            class="px-3 py-1.5 rounded-lg border border-slate-700 bg-slate-900/70 disabled:opacity-40 text-xs">
            ä¸Šä¸€é¡µ
          </button>
          <button
            id="nextPage"
            class="px-3 py-1.5 rounded-lg border border-slate-700 bg-slate-900/70 disabled:opacity-40 text-xs">
            ä¸‹ä¸€é¡µ
          </button>
        </div>
      </div>
    </section>
  </div>

  <!-- è¯¦æƒ…å¼¹çª— -->
  <div
    id="detailModal"
    class="hidden fixed inset-0 z-50 bg-black/70 backdrop-blur-sm items-center justify-center">
    <div class="bg-slate-900/95 border border-slate-700 rounded-2xl max-w-3xl w-[95%] p-4 md:p-5">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-medium text-slate-100">è¯†åˆ«è¯¦æƒ…</h2>
        <button
          id="detailClose"
          class="w-8 h-8 inline-flex items-center justify-center rounded-full bg-slate-800 hover:bg-slate-700 text-slate-300 text-sm">
          âœ•
        </button>
      </div>

      <div class="grid gap-4 md:grid-cols-3">
        <div class="md:col-span-2">
          <dl class="grid grid-cols-2 gap-x-4 gap-y-2 text-xs md:text-sm">
            <div>
              <dt class="text-slate-400">æ—¶é—´</dt>
              <dd id="detailTimestamp" class="mt-1 text-slate-100 break-all"></dd>
            </div>
            <div>
              <dt class="text-slate-400">çŠ¶æ€</dt>
              <dd id="detailStatus" class="mt-1 text-slate-100 break-all"></dd>
            </div>
            <div>
              <dt class="text-slate-400">å§“å</dt>
              <dd id="detailMatchName" class="mt-1 text-slate-100 break-all"></dd>
            </div>
            <div>
              <dt class="text-slate-400">ç›¸ä¼¼åº¦</dt>
              <dd id="detailSimilarity" class="mt-1 text-slate-100 break-all"></dd>
            </div>
            <div>
              <dt class="text-slate-400">é˜ˆå€¼</dt>
              <dd id="detailThreshold" class="mt-1 text-slate-100 break-all"></dd>
            </div>
            <div class="col-span-2">
              <dt class="text-slate-400">æ¶ˆæ¯</dt>
              <dd id="detailMessage" class="mt-1 text-slate-100 break-all text-xs md:text-sm"></dd>
            </div>
          </dl>
        </div>
        <div>
          <div class="text-xs text-slate-400 mb-1">æŠ“æ‹å›¾ç‰‡</div>
          <div
            class="border border-slate-700 rounded-xl bg-slate-950 h-48 md:h-56 flex items-center justify-center overflow-hidden">
            <img
              id="detailImage"
              src=""
              alt="snapshot"
              class="max-h-full max-w-full rounded-md hidden" />
            <span
              id="detailImagePlaceholder"
              class="text-[11px] text-slate-500">
              æ— å›¾ç‰‡è·¯å¾„æˆ–å°šæœªé…ç½®è®¿é—®
            </span>
          </div>
          <p
            id="detailImagePath"
            class="mt-2 text-[11px] text-slate-500 break-all">
          </p>
        </div>
      </div>
    </div>
  </div>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    let currentPage = 1
    const pageSize = 20
    let totalPages = 1
    let currentPageData = []

    let statsCache = null
    let personDailyChart = null
    let dayPeopleChart = null
    let monthPersonChart = null

    // é˜²æŠ–
    function debounce(fn, delay) {
      let timer = null
      return function (...args) {
        clearTimeout(timer)
        timer = setTimeout(() => fn.apply(this, args), delay)
      }
    }

    // çŠ¶æ€å¾½ç« 
    function renderStatusBadge(status) {
      const base =
        'inline-flex items-center px-2 py-[2px] rounded-full text-[11px] font-medium border'
      const s = (status ?? '').toString()
      const upper = s.toUpperCase()

      switch (upper) {
        case 'MATCH':
          return `<span class="${base} bg-emerald-500/10 text-emerald-300 border-emerald-500/40">MATCH</span>`
        case 'ERROR':
          return `<span class="${base} bg-rose-500/10 text-rose-300 border-rose-500/40">ERROR</span>`
        case 'NO_FACE':
          return `<span class="${base} bg-amber-500/10 text-amber-300 border-amber-500/40">NO_FACE</span>`
        case '':
          return `<span class="${base} bg-slate-500/10 text-slate-300 border-slate-500/40">ç©º</span>`
        default:
          return `<span class="${base} bg-slate-500/10 text-slate-300 border-slate-500/40">${s}</span>`
      }
    }

    // è·å–ç»Ÿè®¡æ•°æ®
    async function fetchStats() {
      try {
        const res = await fetch('/api/stats')
        const stats = await res.json()
        statsCache = stats

        document.getElementById('totalCount').textContent = stats.total ?? 0
        document.getElementById('validCount').textContent = stats.valid ?? 0
        document.getElementById('errorCount').textContent = stats.error ?? 0
        document.getElementById('noFaceCount').textContent = stats.no_face ?? 0

        initFiltersFromStats()
        updatePersonDailyChart()
        updateDayPeopleChart()
        updateMonthPersonChart()
      } catch (e) {
        console.error('è·å–ç»Ÿè®¡å¤±è´¥', e)
      }
    }

    // æ ¹æ®ç»Ÿè®¡ç»“æœåˆå§‹åŒ–â€œäººå‘˜â€å’Œâ€œæœˆä»½â€ä¸‹æ‹‰æ¡†
    function initFiltersFromStats() {
      if (!statsCache) return

      const personSelect = document.getElementById('personSelect')
      const monthSelect = document.getElementById('monthSelect')

      const personSet = new Set()
      ;(statsCache.person_day || []).forEach((item) => {
        if (item.person) personSet.add(item.person)
      })

      const monthSet = new Set()
      ;(statsCache.month_person_days || statsCache.month_person || []).forEach((item) => {
        if (item.month) monthSet.add(item.month)
      })

      // äººå‘˜
      personSelect.innerHTML = '<option value="">å…¨éƒ¨äººå‘˜ï¼ˆæ€»æ¬¡æ•°ï¼‰</option>'
      Array.from(personSet)
        .sort()
        .forEach((name) => {
          const opt = document.createElement('option')
          opt.value = name
          opt.textContent = name
          personSelect.appendChild(opt)
        })

      // æœˆä»½
      const months = Array.from(monthSet).sort()
      monthSelect.innerHTML = '<option value="">å…¨éƒ¨æœˆä»½</option>'
      months.forEach((m) => {
        const opt = document.createElement('option')
        opt.value = m
        opt.textContent = m
        monthSelect.appendChild(opt)
      })
      if (months.length > 0) {
        monthSelect.value = months[months.length - 1] // é»˜è®¤é€‰æœ€æ–°æœˆä»½
      }
    }
    // å›¾è¡¨1ï¼šæŸäººæŸæ—¥æ¥äº†å‡ æ¬¡
    function updatePersonDailyChart() {
      if (!statsCache) return

      const person = document.getElementById('personSelect').value
      const arr = statsCache.person_day || []

      const map = {}
      arr.forEach((item) => {
        if (person && item.person !== person) return
        const d = item.date || ''
        if (!map[d]) map[d] = 0
        map[d] += item.count || 0
      })

      const dates = Object.keys(map).sort()
      const counts = dates.map((d) => map[d])

      const ctx = document.getElementById('personDailyChart').getContext('2d')
      if (personDailyChart) personDailyChart.destroy()

      personDailyChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: dates,
          datasets: [
            {
              label: person ? `æœ‰æ•ˆç­¾åˆ°æ¬¡æ•° - ${person}` : 'æ¯å¤©æ€»æœ‰æ•ˆç­¾åˆ°æ¬¡æ•°',
              data: counts,
              borderWidth: 1,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: { color: '#e5e7eb', font: { size: 11 } },
            },
          },
          scales: {
            x: {
              ticks: { color: '#9ca3af', maxRotation: 45, minRotation: 0 },
              grid: { display: false },
            },
            y: {
              ticks: { color: '#9ca3af' },
              grid: { color: 'rgba(55,65,81,0.5)' },
              beginAtZero: true,
            },
          },
        },
      })
    }

    // å›¾è¡¨2ï¼šæŸæ—¥æœ‰å‡ ä¸ªäººæ¥
    function updateDayPeopleChart() {
      if (!statsCache) return

      const arr = statsCache.day_people || []
      const sorted = arr.slice().sort((a, b) => (a.date || '').localeCompare(b.date || ''))

      const labels = sorted.map((i) => i.date || '')
      const people = sorted.map((i) => i.people || 0)

      const ctx = document.getElementById('dayPeopleChart').getContext('2d')
      if (dayPeopleChart) dayPeopleChart.destroy()

      dayPeopleChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'æ¯å¤©æœ‰æ•ˆè®¿å®¢äººæ•°ï¼ˆå»é‡ï¼‰',
              data: people,
              borderWidth: 1.5,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: {
              labels: { color: '#e5e7eb', font: { size: 11 } },
            },
          },
          scales: {
            x: {
              ticks: { color: '#9ca3af', maxRotation: 45, minRotation: 0 },
              grid: { display: false },
            },
            y: {
              ticks: { color: '#9ca3af' },
              grid: { color: 'rgba(55,65,81,0.5)' },
              beginAtZero: true,
            },
          },
        },
      })
    }

    // å›¾è¡¨3ï¼šæŸæœˆæŸäººæ¥çš„å¤©æ•°
    function updateMonthPersonChart() {
      if (!statsCache) return

      const monthSelect = document.getElementById('monthSelect')
      const month = monthSelect.value
      const arr = statsCache.month_person_days || statsCache.month_person || []

      const map = {}
      arr.forEach((item) => {
        if (month && item.month !== month) return
        const p = item.person || 'æœªçŸ¥'
        if (!map[p]) map[p] = 0
        map[p] += item.days || 0
      })

      const persons = Object.keys(map).sort()
      const days = persons.map((p) => map[p])

      const ctx = document.getElementById('monthPersonChart').getContext('2d')
      if (monthPersonChart) monthPersonChart.destroy()

      monthPersonChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: persons,
          datasets: [
            {
              label: month ? `${month} å‡ºå‹¤å¤©æ•°` : 'å‡ºå‹¤å¤©æ•°ï¼ˆæ‰€æœ‰æœˆä»½åˆå¹¶ï¼‰',
              data: days,
              borderWidth: 1,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: { color: '#e5e7eb', font: { size: 11 } },
            },
          },
          scales: {
            x: {
              ticks: { color: '#9ca3af', maxRotation: 45, minRotation: 0 },
              grid: { display: false },
            },
            y: {
              ticks: { color: '#9ca3af' },
              grid: { color: 'rgba(55,65,81,0.5)' },
              beginAtZero: true,
            },
          },
        },
      })
    }
    // åˆ—è¡¨æ•°æ®ï¼ˆåŸå§‹è®°å½•ï¼‰
    async function fetchData() {
      const status = document.getElementById('statusFilter').value
      const q = document.getElementById('searchInput').value.trim()

      const params = new URLSearchParams()
      params.set('page', String(currentPage))
      params.set('pageSize', String(pageSize))
      if (status) params.set('status', status)
      if (q) params.set('q', q)

      try {
        const res = await fetch('/api/records?' + params.toString())
        const json = await res.json()
        currentPageData = json.data || []
        renderTable(currentPageData)
        updateSummary(json)
      } catch (e) {
        console.error('è·å–åˆ—è¡¨å¤±è´¥', e)
      }
    }

    function renderTable(rows) {
      const tbody = document.getElementById('tableBody')
      tbody.innerHTML = ''

      if (!rows || rows.length === 0) {
        const tr = document.createElement('tr')
        tr.innerHTML =
          '<td colspan="8" class="px-3 py-4 text-center text-sm text-slate-500">æš‚æ— æ•°æ®</td>'
        tbody.appendChild(tr)
        return
      }

      rows.forEach((rec, index) => {
        const tr = document.createElement('tr')
        tr.className = 'hover:bg-slate-800/60 transition-colors'
        tr.innerHTML = `
          <td class="px-3 py-2 whitespace-nowrap text-xs text-slate-400">
            ${rec.timestamp || ''}
          </td>
          <td class="px-3 py-2 whitespace-nowrap text-sm">
            ${rec.match_name || '-'}
          </td>
          <td class="px-3 py-2 whitespace-nowrap text-xs">
            ${rec.similarity || '-'}
          </td>
          <td class="px-3 py-2 whitespace-nowrap text-xs text-slate-300">
            ${rec.threshold || '-'}
          </td>
          <td class="px-3 py-2 whitespace-nowrap">
            ${renderStatusBadge(rec.status)}
          </td>
          <td class="px-3 py-2 text-xs max-w-xs">
            <div class="truncate text-slate-400">
              ${rec.image_path || ''}
            </div>
          </td>
          <td class="px-3 py-2 text-xs text-slate-300 max-w-sm">
            <div>
              ${rec.message || ''}
            </div>
          </td>
          <td class="px-3 py-2 whitespace-nowrap text-right text-xs">
            <button
              type="button"
              data-detail-idx="${index}"
              class="inline-flex items-center px-2.5 py-1 rounded-lg bg-sky-500/10 text-sky-300 hover:bg-sky-500/20">
              è¯¦æƒ…
            </button>
          </td>
        `
        tbody.appendChild(tr)
      })
    }

    function updateSummary(meta) {
      const summary = document.getElementById('summary')
      const prevBtn = document.getElementById('prevPage')
      const nextBtn = document.getElementById('nextPage')

      const total = meta.total || 0
      const page = meta.page || 1
      const size = meta.pageSize || pageSize

      totalPages = Math.max(1, Math.ceil(total / size))

      summary.textContent = `å…± ${total} æ¡è®°å½• Â· ç¬¬ ${page} / ${totalPages} é¡µ`

      prevBtn.disabled = page <= 1
      nextBtn.disabled = page >= totalPages
    }
    // æ‰“å¼€è¯¦æƒ…ï¼ˆå›¾ç‰‡é€šè¿‡ /image?path=ABS_PATH æ¥åŠ è½½ï¼‰
    function openDetailModal(rec) {
      document.getElementById('detailTimestamp').textContent = rec.timestamp || '-'
      document.getElementById('detailStatus').textContent = rec.status || '(ç©º)'
      document.getElementById('detailMatchName').textContent = rec.match_name || '-'
      document.getElementById('detailSimilarity').textContent = rec.similarity || '-'
      document.getElementById('detailThreshold').textContent = rec.threshold || '-'
      document.getElementById('detailMessage').textContent = rec.message || ''

      const img = document.getElementById('detailImage')
      const placeholder = document.getElementById('detailImagePlaceholder')
      const pathEl = document.getElementById('detailImagePath')

      if (rec.image_path) {
        const url = '/image?path=' + encodeURIComponent(rec.image_path)
        img.src = url
        img.classList.remove('hidden')
        placeholder.classList.add('hidden')
        pathEl.textContent = rec.image_path
      } else {
        img.src = ''
        img.classList.add('hidden')
        placeholder.classList.remove('hidden')
        pathEl.textContent = ''
      }

      const modal = document.getElementById('detailModal')
      modal.classList.remove('hidden')
      modal.classList.add('flex')
    }

    function closeDetailModal() {
      const modal = document.getElementById('detailModal')
      modal.classList.add('hidden')
      modal.classList.remove('flex')
    }

    document.addEventListener('DOMContentLoaded', () => {
      const searchInput = document.getElementById('searchInput')
      const statusFilter = document.getElementById('statusFilter')
      const prevPage = document.getElementById('prevPage')
      const nextPage = document.getElementById('nextPage')
      const refreshBtn = document.getElementById('refreshBtn')
      const tableBody = document.getElementById('tableBody')
      const detailClose = document.getElementById('detailClose')
      const detailModal = document.getElementById('detailModal')
      const personSelect = document.getElementById('personSelect')
      const monthSelect = document.getElementById('monthSelect')

      searchInput.addEventListener(
        'input',
        debounce(() => {
          currentPage = 1
          fetchData()
        }, 300),
      )

      statusFilter.addEventListener('change', () => {
        currentPage = 1
        fetchData()
      })

      prevPage.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--
          fetchData()
        }
      })

      nextPage.addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++
          fetchData()
        }
      })

      refreshBtn.addEventListener('click', () => {
        fetchStats()
        fetchData()
      })

      personSelect.addEventListener('change', () => {
        updatePersonDailyChart()
      })

      monthSelect.addEventListener('change', () => {
        updateMonthPersonChart()
      })

      // è¯¦æƒ…æŒ‰é’®äº‹ä»¶
      tableBody.addEventListener('click', (e) => {
        const btn = e.target.closest('[data-detail-idx]')
        if (!btn) return
        const idx = parseInt(btn.getAttribute('data-detail-idx'), 10)
        if (Number.isNaN(idx) || !currentPageData[idx]) return
        openDetailModal(currentPageData[idx])
      })

      detailClose.addEventListener('click', closeDetailModal)
      detailModal.addEventListener('click', (e) => {
        if (e.target === detailModal) {
          closeDetailModal()
        }
      })
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeDetailModal()
        }
      })

      // é¦–æ¬¡åŠ è½½
      fetchStats()
      fetchData()
    })
  </script>
</body>
</html>
