<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>äººè„¸è¯†åˆ«ç­¾åˆ°çœ‹æ¿</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <div class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <!-- é¡¶éƒ¨æ ‡é¢˜ -->
    <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
      <div>
        <h1 class="text-3xl font-semibold tracking-tight">
          äººè„¸è¯†åˆ«ç­¾åˆ°çœ‹æ¿
        </h1>
        <p class="text-sm text-slate-400 mt-1">
          ä»…ç»Ÿè®¡ <code>status = MATCH</code> çš„è®°å½•ï¼Œå¹¶æŒ‰ã€ŒåŒä¸€äººåŒä¸€å¤©åªç®—ä¸€æ¬¡ã€åˆå¹¶ä¸ºæœ‰æ•ˆç­¾åˆ°ã€‚
        </p>
      </div>
      <div class="flex items-center gap-3">
        <button
          id="refreshBtn"
          class="inline-flex items-center justify-center px-4 py-2 rounded-xl text-sm font-medium bg-sky-500 hover:bg-sky-400 text-slate-950 shadow-lg shadow-sky-900/40 transition">
          åˆ·æ–°æ•°æ®
        </button>
      </div>
    </header>

    <!-- æ¦‚è§ˆå¡ç‰‡ -->
    <section class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
      <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4">
        <div class="text-xs font-medium text-slate-400">åŸå§‹æ€»è®°å½•æ•°ï¼ˆå«å¼‚å¸¸ï¼‰</div>
        <div id="totalCount" class="mt-2 text-2xl font-semibold">-</div>
      </div>
      <div class="rounded-2xl border border-emerald-500/40 bg-slate-900/70 p-4">
        <div class="text-xs font-medium text-emerald-300">
          æœ‰æ•ˆç­¾åˆ°ï¼ˆåŒä¸€äººåŒä¸€å¤©å»é‡ï¼‰
        </div>
        <div id="validCount" class="mt-2 text-2xl font-semibold text-emerald-300">-</div>
      </div>
      <div class="rounded-2xl border border-rose-500/40 bg-slate-900/70 p-4">
        <div class="text-xs font-medium text-rose-300">ERROR è®°å½•æ•°</div>
        <div id="errorCount" class="mt-2 text-2xl font-semibold text-rose-300">-</div>
      </div>
      <div class="rounded-2xl border border-amber-500/40 bg-slate-900/70 p-4">
        <div class="text-xs font-medium text-amber-300">NO_FACE è®°å½•æ•°</div>
        <div id="noFaceCount" class="mt-2 text-2xl font-semibold text-amber-300">-</div>
      </div>
    </section>

    <!-- æ¯å‘¨ / æ¯æœˆ ç­¾åˆ°äººæ•°æŠ˜çº¿å›¾ -->
    <section class="grid gap-4 lg:grid-cols-2">
      <!-- æ¯å‘¨ç­¾åˆ°äººæ•° -->
      <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 md:p-5">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-sm font-medium text-slate-100">
            æ¯å‘¨ç­¾åˆ°äººæ•°ï¼ˆæŒ‰å¤©å»é‡åï¼Œæ¯å¤©äººæ•°å†æŒ‰å‘¨æ±‡æ€»ï¼‰
          </h2>
        </div>
        <div class="relative h-64 md:h-72">
          <canvas id="weeklySignChart"></canvas>
        </div>
        <p class="mt-2 text-[11px] text-slate-500">
          ä»¥å‘¨ä¸€ä¸ºä¸€å‘¨çš„å¼€å§‹ï¼Œå°†æ¯å¤©æœ‰æ•ˆè®¿å®¢äººæ•°ï¼ˆåŒä¸€äººåŒä¸€å¤©åªç®—ä¸€æ¬¡ï¼‰æŒ‰å‘¨æ±‡æ€»ã€‚
        </p>
      </div>

      <!-- æ¯æœˆç­¾åˆ°äººæ•° -->
      <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 md:p-5">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-sm font-medium text-slate-100">
            æ¯æœˆç­¾åˆ°äººæ•°ï¼ˆæŒ‰å¤©å»é‡åï¼Œæ¯å¤©äººæ•°å†æŒ‰æœˆæ±‡æ€»ï¼‰
          </h2>
        </div>
        <div class="relative h-64 md:h-72">
          <canvas id="monthlySignChart"></canvas>
        </div>
        <p class="mt-2 text-[11px] text-slate-500">
          å°†æ¯å¤©æœ‰æ•ˆè®¿å®¢äººæ•°æŒ‰æ‰€åœ¨æœˆä»½æ±‡æ€»ï¼Œæ¨ªè½´ä¸ºæœˆä»½ï¼ˆYYYY-MMï¼‰ã€‚
        </p>
      </div>
    </section>

    <!-- æŸå‘¨ç­¾åˆ°äººå‘˜è¡¨æ ¼ -->
    <section class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 md:p-5">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
        <div>
          <h2 class="text-sm font-medium text-slate-100">
            æŸå‘¨ç­¾åˆ°äººå‘˜è¡¨æ ¼
          </h2>
          <p class="mt-1 text-[11px] text-slate-500">
            å·¦ä¾§ä¸ºäººå‘˜å§“åï¼ˆæ¥è‡ª <code>label_map.json</code>ï¼‰ï¼Œè¡¨å¤´ä¸ºå‘¨ä¸€è‡³å‘¨æ—¥ï¼Œå•å…ƒæ ¼ä½¿ç”¨ âœ“ è¡¨ç¤ºå½“å¤©æœ‰ç­¾åˆ°ï¼ˆåŒä¸€äººåŒä¸€å¤©åªç®—ä¸€æ¬¡ï¼‰ã€‚
          </p>
        </div>
        <div class="flex items-center gap-2">
          <label for="weekSelect" class="text-xs text-slate-400 whitespace-nowrap">
            é€‰æ‹©å‘¨ï¼š
          </label>
          <select
            id="weekSelect"
            class="text-xs md:text-sm rounded-xl border border-slate-700 bg-slate-900/80 px-3 py-1.5 focus:border-sky-500/70 outline-none min-w-[200px]">
            <option value="">æš‚æ— å‘¨æ•°æ®</option>
          </select>
        </div>
      </div>

      <div class="overflow-x-auto border border-slate-800 rounded-2xl">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-900/80 border-b border-slate-800 text-slate-300">
            <tr>
              <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wide">å§“å</th>
              <th class="px-3 py-2 text-center text-xs font-medium uppercase tracking-wide">å‘¨ä¸€</th>
              <th class="px-3 py-2 text-center text-xs font-medium uppercase tracking-wide">å‘¨äºŒ</th>
              <th class="px-3 py-2 text-center text-xs font-medium uppercase tracking-wide">å‘¨ä¸‰</th>
              <th class="px-3 py-2 text-center text-xs font-medium uppercase tracking-wide">å‘¨å››</th>
              <th class="px-3 py-2 text-center text-xs font-medium uppercase tracking-wide">å‘¨äº”</th>
              <th class="px-3 py-2 text-center text-xs font-medium uppercase tracking-wide">å‘¨å…­</th>
              <th class="px-3 py-2 text-center text-xs font-medium uppercase tracking-wide">å‘¨æ—¥</th>
            </tr>
          </thead>
          <tbody id="weekTableBody" class="divide-y divide-slate-800">
            <!-- JS åŠ¨æ€å¡«å…… -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- æœ€è¿‘ç­¾åˆ°è®°å½•ï¼ˆç²¾ç®€ç‰ˆæ—¥å¿—ï¼Œä¸æ˜¾ç¤ºå›¾ç‰‡è·¯å¾„ï¼‰ -->
    <section class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 md:p-5">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
        <h2 class="text-sm font-medium text-slate-100">
          æœ€è¿‘ç­¾åˆ°è®°å½•ï¼ˆç®€è¦ï¼‰
        </h2>
        <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
          <div class="flex-1">
            <label class="block text-xs font-medium text-slate-400 mb-1">
              æœç´¢ï¼ˆå§“å / çŠ¶æ€ï¼‰
            </label>
            <div
              class="flex items-center gap-2 rounded-xl border border-slate-700 bg-slate-900/60 px-3 py-2 focus-within:border-sky-500/70">
              <span class="text-slate-500 text-sm">ğŸ”</span>
              <input
                id="searchInput"
                type="text"
                placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰ / MATCH / ERROR / NO_FACE"
                class="w-full bg-transparent outline-none text-sm placeholder:text-slate-500" />
            </div>
          </div>
          <div class="w-full sm:w-44">
            <label class="block text-xs font-medium text-slate-400 mb-1">
              çŠ¶æ€ç­›é€‰
            </label>
            <select
              id="statusFilter"
              class="w-full text-sm rounded-xl border border-slate-700 bg-slate-900/80 px-3 py-2 focus:border-sky-500/70 outline-none">
              <option value="">å…¨éƒ¨çŠ¶æ€</option>
              <option value="MATCH">MATCH</option>
              <option value="ERROR">ERROR</option>
              <option value="NO_FACE">NO_FACE</option>
            </select>
          </div>
        </div>
      </div>

      <div class="overflow-x-auto border border-slate-800 rounded-2xl">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-900/80 border-b border-slate-800 text-slate-300">
            <tr>
              <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wide">æ—¶é—´</th>
              <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wide">å§“å</th>
              <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wide">çŠ¶æ€</th>
            </tr>
          </thead>
          <tbody id="tableBody" class="divide-y divide-slate-800"></tbody>
        </table>
      </div>

      <!-- åˆ†é¡µ -->
      <div
        class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mt-4 text-xs text-slate-400">
        <div id="summary">æ­£åœ¨åŠ è½½...</div>
        <div class="flex items-center gap-2">
          <button
            id="prevPage"
            class="px-3 py-1.5 rounded-lg border border-slate-700 bg-slate-900/70 disabled:opacity-40 text-xs">
            ä¸Šä¸€é¡µ
          </button>
          <button
            id="nextPage"
            class="px-3 py-1.5 rounded-lg border border-slate-700 bg-slate-900/70 disabled:opacity-40 text-xs">
            ä¸‹ä¸€é¡µ
          </button>
        </div>
      </div>
    </section>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    let currentPage = 1
    const pageSize = 20
    let totalPages = 1
    let currentPageData = []

    let statsCache = null
    let weeklySignChart = null
    let monthlySignChart = null

    // å‘¨ / æœˆ / å‘¨ç­¾åˆ°è¡¨æ ¼ ä½¿ç”¨çš„è¡ç”Ÿæ•°æ®
    let weekMeta = {}           // weekKey -> { startDate, endDate, label }
    let weeklyPeopleData = []   // [{ weekKey, label, count }]
    let monthlyPeopleData = []  // [{ month, count }]
    let weeklyAttendance = {}   // weekKey -> { person -> { dateStr: true } }
    let allPersons = []         // æ¥è‡ªåç«¯ stats.all_persons

    // é˜²æŠ–
    function debounce(fn, delay) {
      let timer = null
      return function (...args) {
        clearTimeout(timer)
        timer = setTimeout(() => fn.apply(this, args), delay)
      }
    }

    // çŠ¶æ€å¾½ç« ï¼ˆæ—¥å¿—ç”¨ï¼‰
    function renderStatusBadge(status) {
      const base =
        'inline-flex items-center px-2 py-[2px] rounded-full text-[11px] font-medium border'
      const s = (status ?? '').toString()
      const upper = s.toUpperCase()

      switch (upper) {
        case 'MATCH':
          return `<span class="${base} bg-emerald-500/10 text-emerald-300 border-emerald-500/40">MATCH</span>`
        case 'ERROR':
          return `<span class="${base} bg-rose-500/10 text-rose-300 border-rose-500/40">ERROR</span>`
        case 'NO_FACE':
          return `<span class="${base} bg-amber-500/10 text-amber-300 border-amber-500/40">NO_FACE</span>`
        case '':
          return `<span class="${base} bg-slate-500/10 text-slate-300 border-slate-500/40">ç©º</span>`
        default:
          return `<span class="${base} bg-slate-500/10 text-slate-300 border-slate-500/40">${s}</span>`
      }
    }

    // æ ¹æ® yyyy-mm-dd è®¡ç®—â€œå‘¨ä¸€â€çš„æ—¥æœŸå­—ç¬¦ä¸²ä½œä¸º weekKey
    function getWeekKey(dateStr) {
      if (!dateStr) return ''
      const parts = dateStr.split('-').map(Number)
      if (parts.length < 3) return ''
      const [y, m, d] = parts
      const dt = new Date(y, m - 1, d)
      const day = dt.getDay() // 0=å‘¨æ—¥,1=å‘¨ä¸€,...,6=å‘¨å…­
      const offset = (day + 6) % 7 // è½¬æˆâ€œå‘¨ä¸€=0â€çš„åç§»
      dt.setDate(dt.getDate() - offset)
      const yy = dt.getFullYear()
      const mm = String(dt.getMonth() + 1).padStart(2, '0')
      const dd = String(dt.getDate()).padStart(2, '0')
      return `${yy}-${mm}-${dd}`
    }

    // åœ¨ yyyy-mm-dd ä¸ŠåŠ  days å¤©
    function addDays(dateStr, days) {
      const parts = dateStr.split('-').map(Number)
      if (parts.length < 3) return dateStr
      const [y, m, d] = parts
      const dt = new Date(y, m - 1, d)
      dt.setDate(dt.getDate() + days)
      const yy = dt.getFullYear()
      const mm = String(dt.getMonth() + 1).padStart(2, '0')
      const dd = String(dt.getDate()).padStart(2, '0')
      return `${yy}-${mm}-${dd}`
    }

    // åŸºäº statsCache è®¡ç®—å‘¨ / æœˆç»Ÿè®¡å’Œå‘¨ç­¾åˆ°è¡¨æ ¼æ•°æ®
    function buildDerivedFromStats() {
      if (!statsCache) return

      weekMeta = {}
      weeklyPeopleData = []
      monthlyPeopleData = []
      weeklyAttendance = {}
      allPersons = statsCache.all_persons || []

      const dayPeople = statsCache.day_people || []
      const personDay = statsCache.person_day || []

      const weeklyPeopleMap = {} // weekKey -> sum(people)
      const monthlyMap = {}      // yyyy-mm -> sum(people)

      // 1) ä»æ¯å¤©æœ‰æ•ˆè®¿å®¢äººæ•° day_people æ„é€ â€œå‘¨â€å’Œâ€œæœˆâ€çš„äººæ•°æ±‡æ€»
      dayPeople.forEach((item) => {
        const date = item.date || ''
        const people = item.people || 0
        if (!date) return

        const weekKey = getWeekKey(date)
        if (weekKey) {
          if (!weeklyPeopleMap[weekKey]) {
            weeklyPeopleMap[weekKey] = 0
          }
          weeklyPeopleMap[weekKey] += people

          if (!weekMeta[weekKey]) {
            const start = weekKey
            const end = addDays(weekKey, 6)
            weekMeta[weekKey] = {
              startDate: start,
              endDate: end,
              label: `${start} ~ ${end}`,
            }
          }
        }

        const month = date.slice(0, 7)
        if (month) {
          if (!monthlyMap[month]) {
            monthlyMap[month] = 0
          }
          monthlyMap[month] += people
        }
      })

      weeklyPeopleData = Object.keys(weeklyPeopleMap)
        .sort()
        .map((weekKey) => ({
          weekKey,
          label: weekMeta[weekKey]?.label || weekKey,
          count: weeklyPeopleMap[weekKey],
        }))

      monthlyPeopleData = Object.keys(monthlyMap)
        .sort()
        .map((month) => ({
          month,
          count: monthlyMap[month],
        }))

      // 2) åŸºäº person_day æ„é€ â€œæŸå‘¨ç­¾åˆ°äººå‘˜è¡¨æ ¼â€æ•°æ®
      personDay.forEach((item) => {
        const person = item.person || 'æœªçŸ¥'
        const date = item.date || ''
        if (!date || !person) return

        const weekKey = getWeekKey(date)
        if (!weekKey) return

        if (!weekMeta[weekKey]) {
          const start = weekKey
          const end = addDays(weekKey, 6)
          weekMeta[weekKey] = {
            startDate: start,
            endDate: end,
            label: `${start} ~ ${end}`,
          }
        }

        if (!weeklyAttendance[weekKey]) {
          weeklyAttendance[weekKey] = {}
        }
        if (!weeklyAttendance[weekKey][person]) {
          weeklyAttendance[weekKey][person] = {}
        }

        // æŒ‰å¤©å»é‡é€»è¾‘åœ¨åç«¯å·²ç»åšè¿‡ï¼Œè¿™é‡Œåªå…³å¿ƒâ€œæ˜¯å¦æ¥è¿‡â€
        weeklyAttendance[weekKey][person][date] = true
      })

      // å¦‚æœåç«¯æ²¡æœ‰è¿”å› all_personsï¼Œåˆ™é€€åŒ–ä¸ºç”¨ person_day é‡Œå‡ºç°çš„äººå‘˜é›†åˆ
      if (!allPersons || allPersons.length === 0) {
        const set = new Set()
        Object.keys(weeklyAttendance).forEach((wk) => {
          Object.keys(weeklyAttendance[wk]).forEach((p) => set.add(p))
        })
        allPersons = Array.from(set).sort()
      }
    }

    // åˆå§‹åŒ– / æ›´æ–°å‘¨é€‰æ‹©ä¸‹æ‹‰æ¡†
    function initWeekSelect() {
      const weekSelect = document.getElementById('weekSelect')
      const weekKeys = Object.keys(weekMeta).sort()

      if (weekKeys.length === 0) {
        weekSelect.innerHTML = '<option value="">æš‚æ— å‘¨æ•°æ®</option>'
        return
      }

      weekSelect.innerHTML = ''
      weekKeys.forEach((wk) => {
        const opt = document.createElement('option')
        opt.value = wk
        opt.textContent = weekMeta[wk]?.label || wk
        weekSelect.appendChild(opt)
      })

      // é»˜è®¤é€‰æœ€åä¸€å‘¨ï¼ˆæœ€æ–°ï¼‰
      weekSelect.value = weekKeys[weekKeys.length - 1]
    }

    // å›¾è¡¨ï¼šæ¯å‘¨ç­¾åˆ°äººæ•°
    function updateWeeklySignChart() {
      const ctx = document.getElementById('weeklySignChart').getContext('2d')

      if (!weeklyPeopleData || weeklyPeopleData.length === 0) {
        if (weeklySignChart) weeklySignChart.destroy()
        weeklySignChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [
              {
                label: 'æš‚æ— æ•°æ®',
                data: [],
                borderWidth: 1.5,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { labels: { color: '#e5e7eb', font: { size: 11 } } },
            },
            scales: {
              x: {
                ticks: { color: '#9ca3af' },
                grid: { display: false },
              },
              y: {
                ticks: { color: '#9ca3af' },
                grid: { color: 'rgba(55,65,81,0.5)' },
                beginAtZero: true,
              },
            },
          },
        })
        return
      }

      const labels = weeklyPeopleData.map((d) => d.label)
      const counts = weeklyPeopleData.map((d) => d.count)

      if (weeklySignChart) weeklySignChart.destroy()

      weeklySignChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'æ¯å‘¨æœ‰æ•ˆç­¾åˆ°äººæ•°ï¼ˆæŒ‰å¤©å»é‡ï¼‰',
              data: counts,
              borderWidth: 1.5,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { labels: { color: '#e5e7eb', font: { size: 11 } } },
          },
          scales: {
            x: {
              ticks: { color: '#9ca3af', maxRotation: 45, minRotation: 0 },
              grid: { display: false },
            },
            y: {
              ticks: { color: '#9ca3af' },
              grid: { color: 'rgba(55,65,81,0.5)' },
              beginAtZero: true,
            },
          },
        },
      })
    }

    // å›¾è¡¨ï¼šæ¯æœˆç­¾åˆ°äººæ•°
    function updateMonthlySignChart() {
      const ctx = document.getElementById('monthlySignChart').getContext('2d')

      if (!monthlyPeopleData || monthlyPeopleData.length === 0) {
        if (monthlySignChart) monthlySignChart.destroy()
        monthlySignChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [
              {
                label: 'æš‚æ— æ•°æ®',
                data: [],
                borderWidth: 1.5,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { labels: { color: '#e5e7eb', font: { size: 11 } } },
            },
            scales: {
              x: {
                ticks: { color: '#9ca3af' },
                grid: { display: false },
              },
              y: {
                ticks: { color: '#9ca3af' },
                grid: { color: 'rgba(55,65,81,0.5)' },
                beginAtZero: true,
              },
            },
          },
        })
        return
      }

      const labels = monthlyPeopleData.map((d) => d.month)
      const counts = monthlyPeopleData.map((d) => d.count)

      if (monthlySignChart) monthlySignChart.destroy()

      monthlySignChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'æ¯æœˆæœ‰æ•ˆç­¾åˆ°äººæ•°ï¼ˆæŒ‰å¤©å»é‡ï¼‰',
              data: counts,
              borderWidth: 1.5,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { labels: { color: '#e5e7eb', font: { size: 11 } } },
          },
          scales: {
            x: {
              ticks: { color: '#9ca3af', maxRotation: 45, minRotation: 0 },
              grid: { display: false },
            },
            y: {
              ticks: { color: '#9ca3af' },
              grid: { color: 'rgba(55,65,81,0.5)' },
              beginAtZero: true,
            },
          },
        },
      })
    }

    // æ¸²æŸ“â€œæŸå‘¨ç­¾åˆ°äººå‘˜è¡¨æ ¼â€
    function renderWeeklyTable() {
      const tbody = document.getElementById('weekTableBody')
      const weekSelect = document.getElementById('weekSelect')
      const weekKey = weekSelect.value

      tbody.innerHTML = ''

      if (!weekKey || !weeklyAttendance[weekKey]) {
        const tr = document.createElement('tr')
        tr.innerHTML =
          '<td colspan="8" class="px-3 py-4 text-center text-sm text-slate-500">è¯¥å‘¨æš‚æ— ç­¾åˆ°æ•°æ®</td>'
        tbody.appendChild(tr)
        return
      }

      const persons = allPersons && allPersons.length > 0
        ? allPersons
        : Object.keys(weeklyAttendance[weekKey]).sort()

      if (!persons || persons.length === 0) {
        const tr = document.createElement('tr')
        tr.innerHTML =
          '<td colspan="8" class="px-3 py-4 text-center text-sm text-slate-500">è¯¥å‘¨æš‚æ— ç­¾åˆ°æ•°æ®</td>'
        tbody.appendChild(tr)
        return
      }

      persons.forEach((person) => {
        const tr = document.createElement('tr')
        tr.className = 'hover:bg-slate-800/60 transition-colors'
        const cells = []

        // å§“å
        cells.push(
          `<td class="px-3 py-2 whitespace-nowrap text-sm text-slate-100">${person}</td>`,
        )

        // å‘¨ä¸€åˆ°å‘¨æ—¥
        const personData = (weeklyAttendance[weekKey] && weeklyAttendance[weekKey][person]) || {}
        for (let i = 0; i < 7; i++) {
          const dateStr = addDays(weekKey, i)
          const hasSign = !!personData[dateStr]

          if (hasSign) {
            cells.push(
              `<td class="px-3 py-2 text-center text-xs">
                <span class="inline-flex items-center justify-center px-2 py-1 rounded-full bg-emerald-500/10 text-emerald-300 border border-emerald-500/40">
                  âœ“
                </span>
              </td>`,
            )
          } else {
            cells.push(
              '<td class="px-3 py-2 text-center text-xs text-slate-500">â€”</td>',
            )
          }
        }

        tr.innerHTML = cells.join('')
        tbody.appendChild(tr)
      })
    }

    // è·å–ç»Ÿè®¡æ•°æ®
    async function fetchStats() {
      try {
        const res = await fetch('/api/stats')
        const stats = await res.json()
        statsCache = stats

        document.getElementById('totalCount').textContent = stats.total ?? 0
        document.getElementById('validCount').textContent = stats.valid ?? 0
        document.getElementById('errorCount').textContent = stats.error ?? 0
        document.getElementById('noFaceCount').textContent = stats.no_face ?? 0

        // æ„å»ºå‘¨/æœˆ/å‘¨è¡¨æ ¼çš„è¡ç”Ÿæ•°æ®
        buildDerivedFromStats()
        // åˆå§‹åŒ–å‘¨ä¸‹æ‹‰
        initWeekSelect()
        // æ›´æ–°å›¾è¡¨ ä¸ å‘¨ç­¾åˆ°è¡¨æ ¼
        updateWeeklySignChart()
        updateMonthlySignChart()
        renderWeeklyTable()
      } catch (e) {
        console.error('è·å–ç»Ÿè®¡å¤±è´¥', e)
      }
    }

    // åˆ—è¡¨æ•°æ®ï¼ˆç®€åŒ–ç‰ˆåŸå§‹è®°å½•ï¼‰
    async function fetchData() {
      const status = document.getElementById('statusFilter').value
      const q = document.getElementById('searchInput').value.trim()

      const params = new URLSearchParams()
      params.set('page', String(currentPage))
      params.set('pageSize', String(pageSize))
      if (status) params.set('status', status)
      if (q) params.set('q', q)

      try {
        const res = await fetch('/api/records?' + params.toString())
        const json = await res.json()
        currentPageData = json.data || []
        renderTable(currentPageData)
        updateSummary(json)
      } catch (e) {
        console.error('è·å–åˆ—è¡¨å¤±è´¥', e)
      }
    }

    function renderTable(rows) {
      const tbody = document.getElementById('tableBody')
      tbody.innerHTML = ''

      if (!rows || rows.length === 0) {
        const tr = document.createElement('tr')
        tr.innerHTML =
          '<td colspan="3" class="px-3 py-4 text-center text-sm text-slate-500">æš‚æ— æ•°æ®</td>'
        tbody.appendChild(tr)
        return
      }

      rows.forEach((rec) => {
        const tr = document.createElement('tr')
        tr.className = 'hover:bg-slate-800/60 transition-colors'
        tr.innerHTML = `
          <td class="px-3 py-2 whitespace-nowrap text-xs text-slate-400">
            ${rec.timestamp || ''}
          </td>
          <td class="px-3 py-2 whitespace-nowrap text-sm">
            ${rec.match_name || '-'}
          </td>
          <td class="px-3 py-2 whitespace-nowrap">
            ${renderStatusBadge(rec.status)}
          </td>
        `
        tbody.appendChild(tr)
      })
    }

    function updateSummary(meta) {
      const summary = document.getElementById('summary')
      const prevBtn = document.getElementById('prevPage')
      const nextBtn = document.getElementById('nextPage')

      const total = meta.total || 0
      const page = meta.page || 1
      const size = meta.pageSize || pageSize

      totalPages = Math.max(1, Math.ceil(total / size))

      summary.textContent = `å…± ${total} æ¡è®°å½• Â· ç¬¬ ${page} / ${totalPages} é¡µ`

      prevBtn.disabled = page <= 1
      nextBtn.disabled = page >= totalPages
    }
        document.addEventListener('DOMContentLoaded', () => {
      const searchInput = document.getElementById('searchInput')
      const statusFilter = document.getElementById('statusFilter')
      const prevPage = document.getElementById('prevPage')
      const nextPage = document.getElementById('nextPage')
      const refreshBtn = document.getElementById('refreshBtn')
      const weekSelect = document.getElementById('weekSelect')

      // æœç´¢ï¼ˆå§“å / çŠ¶æ€ï¼‰
      searchInput.addEventListener(
        'input',
        debounce(() => {
          currentPage = 1
          fetchData()
        }, 300),
      )

      // çŠ¶æ€ç­›é€‰
      statusFilter.addEventListener('change', () => {
        currentPage = 1
        fetchData()
      })

      // åˆ†é¡µï¼šä¸Šä¸€é¡µ
      prevPage.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--
          fetchData()
        }
      })

      // åˆ†é¡µï¼šä¸‹ä¸€é¡µ
      nextPage.addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++
          fetchData()
        }
      })

      // åˆ·æ–°æŒ‰é’®ï¼šé‡æ–°æ‹‰å–ç»Ÿè®¡å’Œåˆ—è¡¨
      refreshBtn.addEventListener('click', () => {
        fetchStats()
        fetchData()
      })

      // å‘¨é€‰æ‹©ï¼šåˆ‡æ¢å‘¨ç­¾åˆ°è¡¨
      weekSelect.addEventListener('change', () => {
        renderWeeklyTable()
      })

      // é¦–æ¬¡åŠ è½½
      fetchStats()
      fetchData()
    })
  </script>
</body>
</html>

